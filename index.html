<!doctype html>
<html lang="vi" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Th·ªùi Kh√≥a Bi·ªÉu</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="/_sdk/element_sdk.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans:ital,wght@0,300;0,400;0,500;0,600;0,700;0,800;1,300;1,400;1,500;1,600;1,700;1,800&amp;display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" charset="utf-8"></script>
  <style>
    body {
      box-sizing: border-box;
    }
    * {
      font-family: 'Noto Sans', 'Segoe UI', Tahoma, Arial, sans-serif;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      text-rendering: optimizeLegibility;
    }

    @media (max-width: 768px) {
      .mobile-stack {
        flex-direction: column !important;
        gap: 0.5rem !important;
      }
      .mobile-full {
        width: 100% !important;
      }
      .mobile-text-xs {
        font-size: 0.75rem !important;
      }
      .mobile-hide {
        display: none !important;
      }
    }
    
    :root {
      --bg-primary: #ffffff;
      --bg-secondary: #f8fafc;
      --text-primary: #0f172a;
      --text-secondary: #64748b;
      --border-color: #e2e8f0;
      --accent-color: #3b82f6;
    }

    body.theme-minimal {
      --bg-primary: #ffffff;
      --bg-secondary: #f0f9ff;
      --text-primary: #1e3a8a;
      --text-secondary: #3b82f6;
      --border-color: #dbeafe;
      --accent-color: #2563eb;
      --morning-bg: #dbeafe;
      --afternoon-bg: #bfdbfe;
      --morning-subject: #1e40af;
      --morning-info: #3b82f6;
      --afternoon-subject: #1e3a8a;
      --afternoon-info: #2563eb;
    }

    body.theme-ocean {
      --bg-primary: #f0fdff;
      --bg-secondary: #cffafe;
      --text-primary: #155e75;
      --text-secondary: #0e7490;
      --border-color: #a5f3fc;
      --accent-color: #0891b2;
      --morning-bg: #cffafe;
      --afternoon-bg: #a5f3fc;
      --morning-subject: #0e7490;
      --morning-info: #06b6d4;
      --afternoon-subject: #155e75;
      --afternoon-info: #0891b2;
    }

    body.theme-forest {
      --bg-primary: #f0fdf4;
      --bg-secondary: #dcfce7;
      --text-primary: #14532d;
      --text-secondary: #15803d;
      --border-color: #bbf7d0;
      --accent-color: #16a34a;
      --morning-bg: #dcfce7;
      --afternoon-bg: #bbf7d0;
      --morning-subject: #15803d;
      --morning-info: #16a34a;
      --afternoon-subject: #14532d;
      --afternoon-info: #15803d;
    }

    body.theme-sunset {
      --bg-primary: #fff7ed;
      --bg-secondary: #ffedd5;
      --text-primary: #9a3412;
      --text-secondary: #ea580c;
      --border-color: #fed7aa;
      --accent-color: #f97316;
      --morning-bg: #fed7aa;
      --afternoon-bg: #fdba74;
      --morning-subject: #c2410c;
      --morning-info: #ea580c;
      --afternoon-subject: #9a3412;
      --afternoon-info: #c2410c;
    }

    body.theme-mono {
      --bg-primary: #ffffff;
      --bg-secondary: #f5f5f5;
      --text-primary: #000000;
      --text-secondary: #404040;
      --border-color: #e5e5e5;
      --accent-color: #171717;
      --morning-bg: #f5f5f5;
      --afternoon-bg: #e5e5e5;
      --morning-subject: #171717;
      --morning-info: #404040;
      --afternoon-subject: #000000;
      --afternoon-info: #262626;
    }

    body.theme-lavender {
      --bg-primary: #fdf4ff;
      --bg-secondary: #fae8ff;
      --text-primary: #6b21a8;
      --text-secondary: #9333ea;
      --border-color: #e9d5ff;
      --accent-color: #a855f7;
      --morning-bg: #f3e8ff;
      --afternoon-bg: #e9d5ff;
      --morning-subject: #7e22ce;
      --morning-info: #9333ea;
      --afternoon-subject: #6b21a8;
      --afternoon-info: #7e22ce;
    }

    body.theme-rose {
      --bg-primary: #fff1f2;
      --bg-secondary: #ffe4e6;
      --text-primary: #be123c;
      --text-secondary: #e11d48;
      --border-color: #fecdd3;
      --accent-color: #f43f5e;
      --morning-bg: #ffe4e6;
      --afternoon-bg: #fecdd3;
      --morning-subject: #e11d48;
      --morning-info: #f43f5e;
      --afternoon-subject: #be123c;
      --afternoon-info: #e11d48;
    }

    body.theme-amber {
      --bg-primary: #fffbeb;
      --bg-secondary: #fef3c7;
      --text-primary: #b45309;
      --text-secondary: #d97706;
      --border-color: #fde68a;
      --accent-color: #f59e0b;
      --morning-bg: #fef3c7;
      --afternoon-bg: #fde68a;
      --morning-subject: #d97706;
      --morning-info: #f59e0b;
      --afternoon-subject: #b45309;
      --afternoon-info: #d97706;
    }

    body.theme-teal {
      --bg-primary: #f0fdfa;
      --bg-secondary: #ccfbf1;
      --text-primary: #0f766e;
      --text-secondary: #14b8a6;
      --border-color: #99f6e4;
      --accent-color: #14b8a6;
      --morning-bg: #ccfbf1;
      --afternoon-bg: #99f6e4;
      --morning-subject: #0d9488;
      --morning-info: #14b8a6;
      --afternoon-subject: #0f766e;
      --afternoon-info: #0d9488;
    }

    body.theme-indigo {
      --bg-primary: #eef2ff;
      --bg-secondary: #e0e7ff;
      --text-primary: #4338ca;
      --text-secondary: #6366f1;
      --border-color: #c7d2fe;
      --accent-color: #6366f1;
      --morning-bg: #e0e7ff;
      --afternoon-bg: #c7d2fe;
      --morning-subject: #4f46e5;
      --morning-info: #6366f1;
      --afternoon-subject: #4338ca;
      --afternoon-info: #4f46e5;
    }

    body.theme-dark {
      --bg-primary: #0f172a;
      --bg-secondary: #1e293b;
      --text-primary: #f1f5f9;
      --text-secondary: #cbd5e1;
      --border-color: #334155;
      --accent-color: #38bdf8;
      --morning-bg: #334155;
      --afternoon-bg: #475569;
      --morning-subject: #e2e8f0;
      --morning-info: #cbd5e1;
      --afternoon-subject: #f1f5f9;
      --afternoon-info: #e2e8f0;
    }

    .schedule-cell {
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    }
    
    .schedule-cell:hover {
      transform: translateY(-3px) scale(1.02);
      box-shadow: 0 8px 24px rgba(0,0,0,0.15);
    }

    .gradient-header {
      background: linear-gradient(135deg, var(--accent-color) 0%, var(--text-secondary) 100%);
    }

    .glass-effect {
      backdrop-filter: blur(10px);
      background: rgba(255, 255, 255, 0.9);
    }

    @keyframes slideDown {
      from { opacity: 0; transform: translateY(-20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .slide-down {
      animation: slideDown 0.4s ease-out;
    }

    .search-item:hover {
      background: var(--bg-secondary);
    }

    .view-btn.active {
      background: var(--accent-color);
      color: white;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-5px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .fade-in {
      animation: fadeIn 0.3s ease;
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
 </head>
 <body class="h-full theme-minimal" style="background: var(--bg-secondary);">
  <div id="app" class="h-full w-full flex flex-col overflow-auto"><!-- Header -->
   <header class="px-4 py-5 flex-shrink-0 gradient-header slide-down" style="box-shadow: 0 4px 20px rgba(0,0,0,0.1);">
    <div class="max-w-7xl mx-auto">
     <h1 id="app-title" class="text-2xl font-bold mb-1" style="color: white; text-shadow: 0 2px 4px rgba(0,0,0,0.1);">üìö Th·ªùi Kh√≥a Bi·ªÉu</h1>
     <p id="school-name" class="text-sm mb-3" style="color: rgba(255,255,255,0.95);">Tr∆∞·ªùng THPT Nguy·ªÖn Khuy·∫øn - Tu·∫ßn 1 - HKII - 02/02/2026</p>
     <div class="flex gap-2 flex-wrap"><a href="https://tkbnkhoahung.github.io/tkbtuchon12/" target="_blank" rel="noopener noreferrer" class="px-4 py-2 rounded-lg text-sm font-medium transition-all hover:scale-105 shadow-md" style="background: rgba(255,255,255,0.95); color: var(--accent-color);"> üìù TKB T·ª± ch·ªçn 12 </a> <a href="https://tkbnkhoahung.github.io/lichkiemtra/" target="_blank" rel="noopener noreferrer" class="px-4 py-2 rounded-lg text-sm font-medium transition-all hover:scale-105 shadow-md" style="background: rgba(255,255,255,0.95); color: var(--accent-color);"> üìÖ L·ªãch ki·ªÉm tra </a>
     </div>
    </div>
   </header><!-- Controls -->
   <div class="px-4 py-3 flex-shrink-0" style="background: var(--bg-primary); border-bottom: 1px solid var(--border-color);">
    <div class="max-w-7xl mx-auto">
     <div class="flex flex-wrap gap-3 items-center justify-between mb-3 mobile-stack"><!-- View Toggle -->
      <div class="flex items-center gap-2 rounded-lg p-1 mobile-full" style="background: var(--bg-secondary);"><button onclick="setViewMode('overview')" id="btn-overview" class="view-btn px-4 py-2 rounded-md text-sm font-medium transition-all" style="color: var(--text-secondary);"> üìä T·ªïng quan </button> <button onclick="setViewMode('class')" id="btn-class" class="view-btn active px-4 py-2 rounded-md text-sm font-medium transition-all"> üè´ L·ªõp </button> <button onclick="setViewMode('room')" id="btn-room" class="view-btn px-4 py-2 rounded-md text-sm font-medium transition-all" style="color: var(--text-secondary);"> üö™ Ph√≤ng </button>
      </div>
      <div class="flex items-center gap-2 flex-wrap mobile-full"><!-- Class Selector --> <select id="class-selector" onchange="selectClass()" class="px-3 py-2 rounded-lg text-sm font-medium cursor-pointer mobile-full" style="background: var(--bg-primary); border: 1px solid var(--border-color); color: var(--text-primary); display: none;"> <option value="">üè´ Ch·ªçn l·ªõp...</option> </select> <!-- Room Selector --> <select id="room-selector" onchange="selectRoom()" class="px-3 py-2 rounded-lg text-sm font-medium cursor-pointer mobile-full" style="background: var(--bg-primary); border: 1px solid var(--border-color); color: var(--text-primary); display: none;"> <option value="">üö™ Ch·ªçn ph√≤ng...</option> </select> <!-- Theme Selector --> <select id="theme-selector" onchange="changeTheme()" class="px-3 py-2 rounded-lg text-sm font-medium cursor-pointer mobile-full" style="background: var(--bg-primary); border: 1px solid var(--border-color); color: var(--text-primary);"> <option value="minimal">üé® T·ªëi gi·∫£n</option> <option value="ocean">üåä ƒê·∫°i d∆∞∆°ng</option> <option value="forest">üå≤ R·ª´ng xanh</option> <option value="sunset">üåÖ Ho√†ng h√¥n</option> <option value="lavender">üíú Lavender</option> <option value="rose">üåπ H·ªìng</option> <option value="amber">üü° V√†ng h·ªï ph√°ch</option> <option value="teal">üî∑ Xanh ng·ªçc</option> <option value="indigo">üîµ Ch√†m</option> <option value="dark">üåô T·ªëi</option> <option value="mono">‚ö´ ƒêen tr·∫Øng</option> </select> <!-- Load Button --> <button onclick="loadFromGoogleSheet()" id="load-sheet-btn" class="px-3 py-2 rounded-lg text-sm font-medium transition-all shadow-sm flex-1 mobile-hide" style="background: var(--accent-color); color: white;"> <span id="load-text">T·∫£i d·ªØ li·ªáu</span> </button> <!-- Import Button --> <button onclick="showImportModal()" class="px-3 py-2 rounded-lg text-sm font-medium transition-all shadow-sm mobile-full" style="background: var(--accent-color); color: white;"> üì• Nh·∫≠p </button> <!-- Export Button --> <button onclick="exportScheduleImage()" class="px-3 py-2 rounded-lg text-sm font-medium transition-all shadow-sm mobile-full" style="background: var(--accent-color); color: white;"> üì± Xu·∫•t h√¨nh </button>
      </div>
     </div><!-- Search Bar -->
     <div class="relative"><input type="text" id="search-input" placeholder="T√¨m ki·∫øm l·ªõp ho·∫∑c ph√≤ng..." class="w-full px-4 py-2.5 rounded-lg text-sm" style="background: var(--bg-primary); border: 1px solid var(--border-color); color: var(--text-primary);" oninput="handleSearch()" onfocus="showSearchResults()" onblur="setTimeout(hideSearchResults, 200)">
      <div id="search-results" class="hidden absolute top-full mt-1 w-full rounded-lg shadow-lg max-h-64 overflow-y-auto z-50" style="background: var(--bg-primary); border: 1px solid var(--border-color);">
      </div>
     </div>
    </div>
   </div><!-- Import Modal -->
   <div id="import-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4" onclick="closeModalOnBackdrop(event)">
    <div class="rounded-xl shadow-2xl max-w-3xl w-full max-h-[90%] overflow-hidden" style="background: var(--bg-primary);" onclick="event.stopPropagation()">
     <div class="px-6 py-4" style="background: var(--accent-color); color: white;">
      <h2 class="text-xl font-bold">üì• Nh·∫≠p d·ªØ li·ªáu th·ªùi kh√≥a bi·ªÉu</h2>
      <p class="text-sm opacity-90 mt-1">D√°n d·ªØ li·ªáu t·ª´ Excel ho·∫∑c CSV</p>
     </div>
     <div class="p-6 overflow-y-auto max-h-[calc(90vh-200px)]">
      <div class="mb-4"><label class="block text-sm font-medium mb-2" style="color: var(--text-primary);"> ƒê·ªãnh d·∫°ng: Day | Hour | Students Sets | Subject | Teachers | Room </label>
       <div class="p-3 rounded-lg text-xs font-mono mb-4 overflow-x-auto" style="background: var(--bg-secondary); color: var(--text-secondary);">
        <div>
         C3 4 10A1 VƒÇN C. TRANG (V) P101
        </div>
        <div>
         S5 2 10A1 TO√ÅN N. MINH P102
        </div>
       </div>
      </div><textarea id="import-data" class="w-full h-64 px-4 py-3 rounded-lg font-mono text-sm" style="border: 1px solid var(--border-color); background: var(--bg-primary); color: var(--text-primary);" placeholder="D√°n d·ªØ li·ªáu v√†o ƒë√¢y..."></textarea>
      <div id="import-error" class="hidden mt-3 p-3 rounded-lg text-sm" style="background: #fef2f2; border: 1px solid #fecaca; color: #991b1b;"></div>
      <div id="import-success" class="hidden mt-3 p-3 rounded-lg text-sm" style="background: #f0fdf4; border: 1px solid #bbf7d0; color: #166534;"></div>
     </div>
     <div class="px-6 py-4 flex justify-end gap-3" style="background: var(--bg-secondary); border-top: 1px solid var(--border-color);"><button onclick="closeImportModal()" class="px-4 py-2 rounded-lg text-sm font-medium transition-all" style="color: var(--text-secondary);"> H·ªßy </button> <button onclick="processImport()" class="px-4 py-2 rounded-lg text-sm font-medium transition-all" style="background: var(--accent-color); color: white;"> Nh·∫≠p d·ªØ li·ªáu </button>
     </div>
    </div>
   </div><!-- Schedule Grid -->
   <div class="flex-1 overflow-auto p-4">
    <div class="max-w-7xl mx-auto">
     <div id="schedule-container" class="rounded-xl shadow-sm overflow-hidden" style="background: var(--bg-primary); border: 1px solid var(--border-color);"><!-- Schedule will be rendered here -->
     </div>
    </div>
   </div>
  </div>
  <script>
    // Configuration
    const defaultConfig = {
      app_title: 'Th·ªùi Kh√≥a Bi·ªÉu',
      school_name: 'Tr∆∞·ªùng THPT Nguy·ªÖn Khuy·∫øn - Tu·∫ßn 1 - HKII - 19/01/2026'
    };

    let config = { ...defaultConfig };
    let currentView = 'class';
    let currentSelection = '';
    let scheduleByClass = {};
    let scheduleByRoom = {};
    let classes = [];
    let rooms = [];
    let currentTheme = 'minimal';

    const dayMap = {
      'C2': 'Th·ª© 2', 'C3': 'Th·ª© 3', 'C4': 'Th·ª© 4', 
      'C5': 'Th·ª© 5', 'C6': 'Th·ª© 6',
      'S2': 'Th·ª© 2', 'S3': 'Th·ª© 3', 'S4': 'Th·ª© 4',
      'S5': 'Th·ª© 5', 'S6': 'Th·ª© 6'
    };

    const days = ['Th·ª© 2', 'Th·ª© 3', 'Th·ª© 4', 'Th·ª© 5', 'Th·ª© 6'];
    const morningPeriods = ['S√°ng ti·∫øt 1', 'S√°ng ti·∫øt 2', 'S√°ng ti·∫øt 3', 'S√°ng ti·∫øt 4', 'S√°ng ti·∫øt 5'];
    const afternoonPeriods = ['Chi·ªÅu ti·∫øt 1', 'Chi·ªÅu ti·∫øt 2', 'Chi·ªÅu ti·∫øt 3', 'Chi·ªÅu ti·∫øt 4', 'Chi·ªÅu ti·∫øt 5'];

    const SHEET_ID = '1zkJs3cRJp4vLYq3o84HUsdfqHygt_b5rZYjR5OWPDYg';
    const GID = '0';

    // Theme functions
    function changeTheme() {
      const theme = document.getElementById('theme-selector').value;
      currentTheme = theme;
      document.body.className = `h-full theme-${theme}`;
      renderSchedule();
    }

    // Dropdown functions
    function updateDropdowns() {
      const classSelector = document.getElementById('class-selector');
      const roomSelector = document.getElementById('room-selector');

      // Update class dropdown
      classSelector.innerHTML = '<option value="">üè´ Ch·ªçn l·ªõp...</option>';
      classes.forEach(cls => {
        const option = document.createElement('option');
        option.value = cls;
        option.textContent = cls;
        classSelector.appendChild(option);
      });

      // Update room dropdown
      roomSelector.innerHTML = '<option value="">üö™ Ch·ªçn ph√≤ng...</option>';
      rooms.forEach(room => {
        const option = document.createElement('option');
        option.value = room;
        option.textContent = room;
        roomSelector.appendChild(option);
      });

      // Show appropriate dropdown based on current view
      updateDropdownVisibility();
    }

    function updateDropdownVisibility() {
      const classSelector = document.getElementById('class-selector');
      const roomSelector = document.getElementById('room-selector');

      classSelector.style.display = currentView === 'class' ? 'block' : 'none';
      roomSelector.style.display = currentView === 'room' ? 'block' : 'none';

      // Set current selection in dropdown
      if (currentView === 'class' && currentSelection) {
        classSelector.value = currentSelection;
      } else if (currentView === 'room' && currentSelection) {
        roomSelector.value = currentSelection;
      }
    }

    function selectClass() {
      const value = document.getElementById('class-selector').value;
      if (value) {
        currentSelection = value;
        document.getElementById('search-input').value = `L·ªõp ${value}`;
        renderSchedule();
      }
    }

    function selectRoom() {
      const value = document.getElementById('room-selector').value;
      if (value) {
        currentSelection = value;
        document.getElementById('search-input').value = `Ph√≤ng ${value}`;
        renderSchedule();
      }
    }

    // Search functions
    function handleSearch() {
      const query = document.getElementById('search-input').value.toLowerCase().trim();
      const resultsDiv = document.getElementById('search-results');
      
      if (!query) {
        resultsDiv.classList.add('hidden');
        return;
      }

      const classResults = classes.filter(c => c.toLowerCase().includes(query));
      const roomResults = rooms.filter(r => r.toLowerCase().includes(query));

      if (classResults.length === 0 && roomResults.length === 0) {
        resultsDiv.innerHTML = '<div class="p-3 text-sm" style="color: var(--text-secondary);">Kh√¥ng t√¨m th·∫•y k·∫øt qu·∫£</div>';
        resultsDiv.classList.remove('hidden');
        return;
      }

      let html = '';
      
      if (classResults.length > 0) {
        html += '<div class="p-2"><div class="text-xs font-semibold mb-1 px-2" style="color: var(--text-secondary);">L·ªöP H·ªåC</div>';
        classResults.forEach(cls => {
          html += `<div class="search-item p-2 rounded cursor-pointer text-sm" style="color: var(--text-primary);" onmousedown="selectFromSearch('class', '${cls}')">üè´ ${cls}</div>`;
        });
        html += '</div>';
      }

      if (roomResults.length > 0) {
        html += '<div class="p-2"><div class="text-xs font-semibold mb-1 px-2" style="color: var(--text-secondary);">PH√íNG H·ªåC</div>';
        roomResults.forEach(room => {
          html += `<div class="search-item p-2 rounded cursor-pointer text-sm" style="color: var(--text-primary);" onmousedown="selectFromSearch('room', '${room}')">üö™ ${room}</div>`;
        });
        html += '</div>';
      }

      resultsDiv.innerHTML = html;
      resultsDiv.classList.remove('hidden');
    }

    function showSearchResults() {
      if (document.getElementById('search-input').value.trim()) {
        handleSearch();
      }
    }

    function hideSearchResults() {
      document.getElementById('search-results').classList.add('hidden');
    }

    function selectFromSearch(type, value) {
      currentView = type;
      currentSelection = value;
      
      if (type === 'class') {
        document.getElementById('search-input').value = `L·ªõp ${value}`;
      } else if (type === 'room') {
        document.getElementById('search-input').value = `Ph√≤ng ${value}`;
      }
      
      document.getElementById('btn-overview').classList.toggle('active', false);
      document.getElementById('btn-class').classList.toggle('active', type === 'class');
      document.getElementById('btn-room').classList.toggle('active', type === 'room');
      
      updateDropdownVisibility();
      renderSchedule();
      hideSearchResults();
    }

    // Load from Google Sheet
    async function loadFromGoogleSheet() {
      const loadBtn = document.getElementById('load-sheet-btn');
      const loadText = document.getElementById('load-text');
      
      loadBtn.disabled = true;
      loadBtn.style.opacity = '0.6';
      loadText.textContent = 'ƒêang t·∫£i...';

      try {
        const csvUrl = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&gid=${GID}`;
        const response = await fetch(csvUrl);
        
        if (!response.ok) {
          throw new Error('Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu. Ki·ªÉm tra quy·ªÅn truy c·∫≠p.');
        }

        const csvText = await response.text();
        const lines = csvText.split('\n').filter(line => line.trim());
        
        if (lines.length === 0) {
          throw new Error('Sheet kh√¥ng c√≥ d·ªØ li·ªáu');
        }

        let startIndex = 0;
        const firstLine = lines[0].toLowerCase();
        if (firstLine.includes('day') || firstLine.includes('hour') || firstLine.includes('subject')) {
          startIndex = 1;
        }

        scheduleByClass = {};
        scheduleByRoom = {};
        const classSet = new Set();
        const roomSet = new Set();

        let importedCount = 0;

        for (let i = startIndex; i < lines.length; i++) {
          const line = lines[i].trim();
          if (!line) continue;

          const parts = parseCSVLine(line);
          
          if (parts.length < 4) continue;

          const dayCode = parts[0].toUpperCase();
          const hour = parseInt(parts[1]);
          const studentSet = parts[2];
          const subject = parts[3].toUpperCase().replace(/\s+/g, '');
          const teacher = parts[4] || 'Ch∆∞a ph√¢n c√¥ng';
          const room = parts[5] || '';

          const isMorning = dayCode.startsWith('S');
          const isAfternoon = dayCode.startsWith('C');
          
          if (!isMorning && !isAfternoon) continue;

          const dayName = dayMap[dayCode];
          if (!dayName) continue;
          if (isNaN(hour) || hour < 1 || hour > 5) continue;

          const periodName = isMorning ? `S√°ng ti·∫øt ${hour}` : `Chi·ªÅu ti·∫øt ${hour}`;

          if (!scheduleByClass[studentSet]) {
            scheduleByClass[studentSet] = {};
            days.forEach(d => {
              scheduleByClass[studentSet][d] = {};
            });
          }

          if (room && !scheduleByRoom[room]) {
            scheduleByRoom[room] = {};
            days.forEach(d => {
              scheduleByRoom[room][d] = {};
            });
          }

          scheduleByClass[studentSet][dayName][periodName] = {
            subject: subject,
            teacher: teacher,
            room: room
          };

          if (room) {
            scheduleByRoom[room][dayName][periodName] = {
              subject: subject,
              class: studentSet,
              teacher: teacher
            };
            roomSet.add(room);
          }

          classSet.add(studentSet);
          importedCount++;
        }

        if (importedCount === 0) {
          throw new Error('Kh√¥ng c√≥ d·ªØ li·ªáu h·ª£p l·ªá');
        }

        classes = Array.from(classSet).sort();
        rooms = Array.from(roomSet).sort();

        if (classes.length === 0) {
          throw new Error('Kh√¥ng t√¨m th·∫•y l·ªõp n√†o');
        }

        updateDropdowns();

        loadText.textContent = `‚úì ƒê√£ t·∫£i ${importedCount} ti·∫øt`;
        
        setTimeout(() => {
          loadText.textContent = 'T·∫£i d·ªØ li·ªáu';
          loadBtn.disabled = false;
          loadBtn.style.opacity = '1';
        }, 2000);

        currentView = 'class';
        currentSelection = classes[0];
        setViewMode('class');

      } catch (error) {
        loadText.textContent = '‚úó L·ªói';
        
        const errorDiv = document.createElement('div');
        errorDiv.className = 'fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg z-50';
        errorDiv.style.background = '#dc2626';
        errorDiv.style.color = 'white';
        errorDiv.textContent = error.message;
        document.body.appendChild(errorDiv);
        
        setTimeout(() => {
          errorDiv.remove();
          loadText.textContent = 'T·∫£i d·ªØ li·ªáu';
          loadBtn.disabled = false;
          loadBtn.style.opacity = '1';
        }, 3000);
      }
    }

    function parseCSVLine(line) {
      const result = [];
      let current = '';
      let inQuotes = false;
      
      for (let i = 0; i < line.length; i++) {
        const char = line[i];
        
        if (char === '"') {
          inQuotes = !inQuotes;
        } else if (char === ',' && !inQuotes) {
          result.push(current.trim());
          current = '';
        } else {
          current += char;
        }
      }
      
      result.push(current.trim());
      return result;
    }

    // Modal functions
    function showImportModal() {
      document.getElementById('import-modal').classList.remove('hidden');
      document.getElementById('import-modal').classList.add('flex');
      document.getElementById('import-error').classList.add('hidden');
      document.getElementById('import-success').classList.add('hidden');
    }

    function closeImportModal() {
      document.getElementById('import-modal').classList.add('hidden');
      document.getElementById('import-modal').classList.remove('flex');
      document.getElementById('import-data').value = '';
    }

    function closeModalOnBackdrop(event) {
      if (event.target.id === 'import-modal') {
        closeImportModal();
      }
    }

    function processImport() {
      const data = document.getElementById('import-data').value.trim();
      const errorDiv = document.getElementById('import-error');
      const successDiv = document.getElementById('import-success');
      
      errorDiv.classList.add('hidden');
      successDiv.classList.add('hidden');

      if (!data) {
        errorDiv.textContent = '‚ö†Ô∏è Vui l√≤ng nh·∫≠p d·ªØ li·ªáu!';
        errorDiv.classList.remove('hidden');
        return;
      }

      try {
        const lines = data.split('\n').filter(line => line.trim());
        
        if (lines.length === 0) {
          throw new Error('Kh√¥ng c√≥ d·ªØ li·ªáu h·ª£p l·ªá');
        }

        let startIndex = 0;
        const firstLine = lines[0].toLowerCase();
        if (firstLine.includes('day') || firstLine.includes('hour') || firstLine.includes('subject')) {
          startIndex = 1;
        }

        scheduleByClass = {};
        scheduleByRoom = {};
        const classSet = new Set();
        const roomSet = new Set();

        let importedCount = 0;

        for (let i = startIndex; i < lines.length; i++) {
          const line = lines[i].trim();
          if (!line) continue;

          const parts = line.split(/\t+|\s{2,}/).map(p => p.trim()).filter(p => p);
          
          if (parts.length < 4) continue;

          const dayCode = parts[0].toUpperCase();
          const hour = parseInt(parts[1]);
          const studentSet = parts[2];
          const subject = parts[3].toUpperCase();
          const teacher = parts[4] || 'Ch∆∞a ph√¢n c√¥ng';
          const room = parts[5] || '';

          const isMorning = dayCode.startsWith('S');
          const isAfternoon = dayCode.startsWith('C');
          
          if (!isMorning && !isAfternoon) continue;

          const dayName = dayMap[dayCode];
          if (!dayName) continue;
          if (isNaN(hour) || hour < 1 || hour > 5) continue;

          const periodName = isMorning ? `S√°ng ti·∫øt ${hour}` : `Chi·ªÅu ti·∫øt ${hour}`;

          if (!scheduleByClass[studentSet]) {
            scheduleByClass[studentSet] = {};
            days.forEach(d => {
              scheduleByClass[studentSet][d] = {};
            });
          }

          if (room && !scheduleByRoom[room]) {
            scheduleByRoom[room] = {};
            days.forEach(d => {
              scheduleByRoom[room][d] = {};
            });
          }

          scheduleByClass[studentSet][dayName][periodName] = {
            subject: subject,
            teacher: teacher,
            room: room
          };

          if (room) {
            scheduleByRoom[room][dayName][periodName] = {
              subject: subject,
              class: studentSet,
              teacher: teacher
            };
            roomSet.add(room);
          }

          classSet.add(studentSet);
          importedCount++;
        }

        if (importedCount === 0) {
          throw new Error('Kh√¥ng c√≥ d·ªØ li·ªáu h·ª£p l·ªá');
        }

        classes = Array.from(classSet).sort();
        rooms = Array.from(roomSet).sort();

        if (classes.length === 0) {
          throw new Error('Kh√¥ng t√¨m th·∫•y l·ªõp n√†o');
        }

        updateDropdowns();

        successDiv.textContent = `‚úÖ ƒê√£ nh·∫≠p ${importedCount} ti·∫øt h·ªçc!`;
        successDiv.classList.remove('hidden');

        setTimeout(() => {
          closeImportModal();
          currentView = 'class';
          currentSelection = classes[0];
          setViewMode('class');
        }, 1500);

      } catch (error) {
        errorDiv.textContent = `‚ùå L·ªói: ${error.message}`;
        errorDiv.classList.remove('hidden');
      }
    }

    // Statistics calculation
    function calculateSelectionStats(schedule) {
      const stats = {
        totalLessons: 0,
        morningLessons: 0,
        afternoonLessons: 0,
        subjects: {}
      };

      days.forEach(day => {
        if (schedule[day]) {
          Object.keys(schedule[day]).forEach(period => {
            const lesson = schedule[day][period];
            if (lesson) {
              stats.totalLessons++;
              
              if (period.startsWith('S√°ng')) {
                stats.morningLessons++;
              } else {
                stats.afternoonLessons++;
              }

              // Count by subject/class depending on view
              let key;
              if (currentView === 'class') {
                key = lesson.subject;
              } else if (currentView === 'teacher') {
                key = lesson.class;
              } else if (currentView === 'room') {
                key = lesson.class;
              }

              if (key) {
                if (!stats.subjects[key]) {
                  stats.subjects[key] = 0;
                }
                stats.subjects[key]++;
              }
            }
          });
        }
      });

      return stats;
    }

    // View functions
    function setViewMode(mode) {
      currentView = mode;
      
      document.getElementById('btn-overview').classList.toggle('active', mode === 'overview');
      document.getElementById('btn-class').classList.toggle('active', mode === 'class');
      document.getElementById('btn-room').classList.toggle('active', mode === 'room');

      if (mode === 'class' && classes.length > 0) {
        currentSelection = classes[0];
      } else if (mode === 'room' && rooms.length > 0) {
        currentSelection = rooms[0];
      } else if (mode === 'overview') {
        currentSelection = '';
      }
      
      document.getElementById('search-input').value = '';
      updateDropdownVisibility();
      renderSchedule();
    }

    function renderSchedule() {
      const container = document.getElementById('schedule-container');
      
      // Render overview statistics
      if (currentView === 'overview') {
        renderOverview(container);
        return;
      }
      
      let schedule;
      
      if (currentView === 'class') {
        schedule = scheduleByClass[currentSelection];
      } else if (currentView === 'room') {
        schedule = scheduleByRoom[currentSelection];
      }

      if (!schedule || !currentSelection) {
        container.innerHTML = '<div class="p-8 text-center text-sm" style="color: var(--text-secondary);">Vui l√≤ng ch·ªçn l·ªõp ho·∫∑c ph√≤ng t·ª´ dropdown</div>';
        return;
      }

      // Calculate statistics for current selection
      const stats = calculateSelectionStats(schedule);

      const morningTimes = ['7:00-7:45', '7:45-8:30', '9:00-9:45', '9:45-10:30', '10:30-11:15'];
      const afternoonTimes = ['1:00-1:45', '1:45-2:30', '2:30-3:15', '3:45-4:30', '4:30-5:15'];

      // Check which periods have lessons
      const hasLesson = (period) => {
        return days.some(day => schedule[day] && schedule[day][period]);
      };

      const activeMorningPeriods = morningPeriods.filter(hasLesson);
      const activeAfternoonPeriods = afternoonPeriods.filter(hasLesson);

      let viewTitle = '';
      if (currentView === 'class') {
        viewTitle = `üè´ L·ªõp ${currentSelection}`;
      } else if (currentView === 'room') {
        viewTitle = `üö™ Ph√≤ng ${currentSelection}`;
      }

      let html = `
        <div class="p-4 border-b" style="border-color: var(--border-color);">
          <div class="flex justify-between items-start mb-4">
            <div class="text-lg font-semibold" style="color: var(--text-primary);">
              ${viewTitle}
            </div>
          </div>
          
          <!-- Statistics Cards -->
          <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mt-4">
            <div class="p-3 rounded-lg" style="background: var(--bg-secondary); border: 2px solid var(--border-color);">
              <div class="text-2xl mb-1">üìö</div>
              <div class="text-2xl font-bold" style="color: var(--text-primary);">${stats.totalLessons}</div>
              <div class="text-xs font-medium" style="color: var(--text-secondary);">T·ªïng ti·∫øt</div>
            </div>
            <div class="p-3 rounded-lg" style="background: var(--bg-secondary); border: 2px solid var(--border-color);">
              <div class="text-2xl mb-1">‚òÄÔ∏è</div>
              <div class="text-2xl font-bold" style="color: var(--text-primary);">${stats.morningLessons}</div>
              <div class="text-xs font-medium" style="color: var(--text-secondary);">Ti·∫øt s√°ng</div>
            </div>
            <div class="p-3 rounded-lg" style="background: var(--bg-secondary); border: 2px solid var(--border-color);">
              <div class="text-2xl mb-1">üåô</div>
              <div class="text-2xl font-bold" style="color: var(--text-primary);">${stats.afternoonLessons}</div>
              <div class="text-xs font-medium" style="color: var(--text-secondary);">Ti·∫øt chi·ªÅu</div>
            </div>
            <div class="p-3 rounded-lg" style="background: var(--bg-secondary); border: 2px solid var(--border-color);">
              <div class="text-2xl mb-1">üìñ</div>
              <div class="text-2xl font-bold" style="color: var(--text-primary);">${Object.keys(stats.subjects).length}</div>
              <div class="text-xs font-medium" style="color: var(--text-secondary);">${currentView === 'class' ? 'M√¥n h·ªçc' : 'L·ªõp h·ªçc'}</div>
            </div>
          </div>

          <!-- Detailed Statistics -->
          <div class="mt-4 p-4 rounded-lg" style="background: var(--bg-secondary); border: 2px solid var(--border-color);">
            <div class="text-sm font-semibold mb-3" style="color: var(--text-primary);">
              ${currentView === 'class' ? 'üìä Th·ªëng k√™ m√¥n h·ªçc' : 'üìä Th·ªëng k√™ l·ªõp h·ªçc'}
            </div>
            <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-2">
              ${Object.entries(stats.subjects).sort((a, b) => b[1] - a[1]).map(([name, count]) => `
                <div class="flex justify-between items-center p-2 rounded-lg" style="background: var(--bg-primary); border: 1px solid var(--border-color);">
                  <span class="text-sm font-medium truncate" style="color: var(--text-primary);">${name}</span>
                  <span class="ml-2 px-2 py-0.5 rounded-full text-xs font-bold whitespace-nowrap" style="background: var(--accent-color); color: white;">${count}</span>
                </div>
              `).join('')}
            </div>
          </div>
        </div>
        <div class="overflow-x-auto">
          <table class="w-full min-w-[800px]">
            <thead>
              <tr style="background: var(--bg-secondary);">
                <th class="px-3 py-3 text-left text-xs font-semibold uppercase tracking-wider w-24" style="color: var(--text-secondary); border-bottom: 1px solid var(--border-color); border-right: 1px solid var(--border-color);">
                  Ti·∫øt
                </th>
      `;

      days.forEach(day => {
        html += `
          <th class="px-3 py-3 text-center text-xs font-semibold uppercase tracking-wider" style="color: var(--text-secondary); border-bottom: 1px solid var(--border-color); border-right: 1px solid var(--border-color);">
            ${day}
          </th>
        `;
      });

      html += `</tr></thead><tbody>`;

      // Morning sessions
      activeMorningPeriods.forEach((period) => {
        const periodIdx = morningPeriods.indexOf(period);
        html += `<tr>
          <td class="px-3 py-2 text-xs" style="background: var(--bg-secondary); border-right: 1px solid var(--border-color); border-bottom: 1px solid var(--border-color); color: var(--text-primary);">
            <div class="font-medium">S√°ng ${periodIdx + 1}</div>
            <div class="opacity-60">${morningTimes[periodIdx]}</div>
          </td>
        `;

        days.forEach(day => {
          const lesson = schedule[day] ? schedule[day][period] : null;
          if (lesson) {
            html += `
              <td class="px-2 py-2" style="border-right: 1px solid var(--border-color); border-bottom: 1px solid var(--border-color);">
                <div class="schedule-cell rounded-lg p-3 fade-in" style="background: var(--morning-bg); min-height: 70px; display: flex; flex-direction: column; justify-content: center;">
                  <div class="font-bold text-base mb-1.5" style="color: var(--morning-subject);">${lesson.subject}</div>
                  <div class="text-sm font-medium mb-0.5" style="color: var(--morning-info);">
                    ${currentView === 'class' ? lesson.teacher : lesson.class}
                  </div>
                  ${currentView === 'room' && lesson.teacher ? `<div class="text-xs" style="color: var(--morning-info); opacity: 0.75;">${lesson.teacher}</div>` : ''}
                  ${currentView !== 'room' && lesson.room ? `<div class="text-xs" style="color: var(--morning-info); opacity: 0.75;">${lesson.room}</div>` : ''}
                </div>
              </td>
            `;
          } else {
            html += `<td style="border-right: 1px solid var(--border-color); border-bottom: 1px solid var(--border-color);"></td>`;
          }
        });

        html += `</tr>`;
      });

      // Afternoon sessions
      activeAfternoonPeriods.forEach((period) => {
        const periodIdx = afternoonPeriods.indexOf(period);
        html += `<tr>
          <td class="px-3 py-2 text-xs" style="background: var(--bg-secondary); border-right: 1px solid var(--border-color); border-bottom: 1px solid var(--border-color); color: var(--text-primary);">
            <div class="font-medium">Chi·ªÅu ${periodIdx + 1}</div>
            <div class="opacity-60">${afternoonTimes[periodIdx]}</div>
          </td>
        `;

        days.forEach(day => {
          const lesson = schedule[day] ? schedule[day][period] : null;
          if (lesson) {
            html += `
              <td class="px-2 py-2" style="border-right: 1px solid var(--border-color); border-bottom: 1px solid var(--border-color);">
                <div class="schedule-cell rounded-lg p-3 fade-in" style="background: var(--afternoon-bg); min-height: 70px; display: flex; flex-direction: column; justify-content: center;">
                  <div class="font-bold text-base mb-1.5" style="color: var(--afternoon-subject);">${lesson.subject}</div>
                  <div class="text-sm font-medium mb-0.5" style="color: var(--afternoon-info);">
                    ${currentView === 'class' ? lesson.teacher : (currentView === 'teacher' ? lesson.class : lesson.class)}
                  </div>
                  ${currentView === 'room' && lesson.teacher ? `<div class="text-xs" style="color: var(--afternoon-info); opacity: 0.75;">${lesson.teacher}</div>` : ''}
                  ${currentView !== 'room' && lesson.room ? `<div class="text-xs" style="color: var(--afternoon-info); opacity: 0.75;">${lesson.room}</div>` : ''}
                </div>
              </td>
            `;
          } else {
            html += `<td style="border-right: 1px solid var(--border-color); border-bottom: 1px solid var(--border-color);"></td>`;
          }
        });

        html += `</tr>`;
      });

      html += `</tbody></table></div>`;
      container.innerHTML = html;
    }

    function renderOverview(container) {
      if (classes.length === 0 && teachers.length === 0 && rooms.length === 0) {
        container.innerHTML = '<div class="p-8 text-center text-sm" style="color: var(--text-secondary);">Ch∆∞a c√≥ d·ªØ li·ªáu th·ªùi kh√≥a bi·ªÉu. Vui l√≤ng nh·∫≠p d·ªØ li·ªáu ho·∫∑c t·∫£i t·ª´ Google Sheet.</div>';
        return;
      }

      // Calculate statistics
      const stats = {
        totalClasses: classes.length,
        totalTeachers: teachers.length,
        totalRooms: rooms.length,
        totalLessons: 0,
        subjectStats: {},
        teacherWorkload: {},
        roomUsage: {}
      };

      // Count lessons and subjects
      Object.keys(scheduleByClass).forEach(className => {
        Object.keys(scheduleByClass[className]).forEach(day => {
          Object.keys(scheduleByClass[className][day]).forEach(period => {
            const lesson = scheduleByClass[className][day][period];
            if (lesson) {
              stats.totalLessons++;
              
              // Subject statistics
              if (!stats.subjectStats[lesson.subject]) {
                stats.subjectStats[lesson.subject] = 0;
              }
              stats.subjectStats[lesson.subject]++;
            }
          });
        });
      });

      // Teacher workload
      Object.keys(scheduleByTeacher).forEach(teacher => {
        let count = 0;
        Object.keys(scheduleByTeacher[teacher]).forEach(day => {
          Object.keys(scheduleByTeacher[teacher][day]).forEach(period => {
            if (scheduleByTeacher[teacher][day][period]) {
              count++;
            }
          });
        });
        stats.teacherWorkload[teacher] = count;
      });

      // Room usage
      Object.keys(scheduleByRoom).forEach(room => {
        let count = 0;
        Object.keys(scheduleByRoom[room]).forEach(day => {
          Object.keys(scheduleByRoom[room][day]).forEach(period => {
            if (scheduleByRoom[room][day][period]) {
              count++;
            }
          });
        });
        stats.roomUsage[room] = count;
      });

      // Sort for display
      const sortedSubjects = Object.entries(stats.subjectStats).sort((a, b) => b[1] - a[1]);
      const sortedTeachers = Object.entries(stats.teacherWorkload).sort((a, b) => b[1] - a[1]);
      const sortedRooms = Object.entries(stats.roomUsage).sort((a, b) => b[1] - a[1]);

      let html = `
        <div class="p-6">
          <div class="mb-6">
            <h2 class="text-2xl font-bold mb-2" style="color: var(--text-primary);">üìä T·ªïng quan th·ªùi kh√≥a bi·ªÉu</h2>
            <p class="text-sm" style="color: var(--text-secondary);">Th·ªëng k√™ chi ti·∫øt v·ªÅ l·ªõp h·ªçc, gi√°o vi√™n v√† ph√≤ng h·ªçc</p>
          </div>

          <!-- Summary Cards -->
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
            <div class="p-5 rounded-xl shadow-sm hover:shadow-md transition-all" style="background: var(--bg-secondary); border: 2px solid var(--border-color);">
              <div class="text-4xl mb-3">üè´</div>
              <div class="text-3xl font-bold mb-1" style="color: var(--text-primary);">${stats.totalClasses}</div>
              <div class="text-sm font-medium" style="color: var(--text-secondary);">L·ªõp h·ªçc</div>
            </div>
            <div class="p-5 rounded-xl shadow-sm hover:shadow-md transition-all" style="background: var(--bg-secondary); border: 2px solid var(--border-color);">
              <div class="text-4xl mb-3">ÔøΩÔøΩÔøΩ‚Äçüè´</div>
              <div class="text-3xl font-bold mb-1" style="color: var(--text-primary);">${stats.totalTeachers}</div>
              <div class="text-sm font-medium" style="color: var(--text-secondary);">Gi√°o vi√™n</div>
            </div>
            <div class="p-5 rounded-xl shadow-sm hover:shadow-md transition-all" style="background: var(--bg-secondary); border: 2px solid var(--border-color);">
              <div class="text-4xl mb-3">üö™</div>
              <div class="text-3xl font-bold mb-1" style="color: var(--text-primary);">${stats.totalRooms}</div>
              <div class="text-sm font-medium" style="color: var(--text-secondary);">Ph√≤ng h·ªçc</div>
            </div>
            <div class="p-5 rounded-xl shadow-sm hover:shadow-md transition-all" style="background: var(--bg-secondary); border: 2px solid var(--border-color);">
              <div class="text-4xl mb-3">üìö</div>
              <div class="text-3xl font-bold mb-1" style="color: var(--text-primary);">${stats.totalLessons}</div>
              <div class="text-sm font-medium" style="color: var(--text-secondary);">T·ªïng ti·∫øt h·ªçc</div>
            </div>
          </div>

          <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- Subject Statistics -->
            <div class="rounded-xl p-5 shadow-sm" style="background: var(--bg-secondary); border: 2px solid var(--border-color);">
              <div class="flex items-center gap-3 mb-4 pb-3" style="border-bottom: 2px solid var(--border-color);">
                <div class="text-3xl">üìñ</div>
                <div>
                  <h3 class="text-lg font-bold" style="color: var(--text-primary);">M√¥n h·ªçc</h3>
                  <p class="text-xs" style="color: var(--text-secondary);">${sortedSubjects.length} m√¥n</p>
                </div>
              </div>
              <div class="space-y-2 max-h-96 overflow-y-auto">
                ${sortedSubjects.map(([subject, count]) => `
                  <div class="flex justify-between items-center p-3 rounded-lg hover:scale-102 transition-all" style="background: var(--bg-primary); border: 1px solid var(--border-color);">
                    <span class="font-semibold text-sm" style="color: var(--text-primary);">${subject}</span>
                    <span class="px-3 py-1 rounded-full text-xs font-bold" style="background: var(--accent-color); color: white;">${count} ti·∫øt</span>
                  </div>
                `).join('')}
              </div>
            </div>

            <!-- Room Usage -->
            <div class="rounded-xl p-5 shadow-sm" style="background: var(--bg-secondary); border: 2px solid var(--border-color);">
              <div class="flex items-center gap-3 mb-4 pb-3" style="border-bottom: 2px solid var(--border-color);">
                <div class="text-3xl">üö™</div>
                <div>
                  <h3 class="text-lg font-bold" style="color: var(--text-primary);">Ph√≤ng h·ªçc</h3>
                  <p class="text-xs" style="color: var(--text-secondary);">${sortedRooms.length} ph√≤ng</p>
                </div>
              </div>
              <div class="space-y-2 max-h-96 overflow-y-auto">
                ${sortedRooms.map(([room, count]) => `
                  <div class="flex justify-between items-center p-3 rounded-lg hover:scale-102 transition-all cursor-pointer" style="background: var(--bg-primary); border: 1px solid var(--border-color);" onclick="selectFromSearch('room', '${room}')">
                    <span class="font-semibold text-sm" style="color: var(--text-primary);">${room}</span>
                    <span class="px-3 py-1 rounded-full text-xs font-bold" style="background: var(--accent-color); color: white;">${count} ti·∫øt</span>
                  </div>
                `).join('')}
              </div>
            </div>
          </div>
        </div>
      `;

      container.innerHTML = html;
    }

    function applyConfig(cfg) {
      document.getElementById('app-title').textContent = cfg.app_title || defaultConfig.app_title;
      document.getElementById('school-name').textContent = cfg.school_name || defaultConfig.school_name;
    }

    // Initialize Element SDK
    if (window.elementSdk) {
      window.elementSdk.init({
        defaultConfig,
        onConfigChange: async (cfg) => {
          config = { ...defaultConfig, ...cfg };
          applyConfig(config);
        },
        mapToCapabilities: (cfg) => ({
          recolorables: [],
          borderables: [],
          fontEditable: undefined,
          fontSizeable: undefined
        }),
        mapToEditPanelValues: (cfg) => new Map([
          ['app_title', cfg.app_title || defaultConfig.app_title],
          ['school_name', cfg.school_name || defaultConfig.school_name]
        ])
      });
    }

    // Export schedule as image
    async function exportScheduleImage() {
      if (!currentSelection) {
        const toast = document.createElement('div');
        toast.className = 'fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg z-50';
        toast.style.background = '#dc2626';
        toast.style.color = 'white';
        toast.textContent = 'Vui l√≤ng ch·ªçn l·ªõp, gi√°o vi√™n ho·∫∑c ph√≤ng tr∆∞·ªõc!';
        document.body.appendChild(toast);
        setTimeout(() => toast.remove(), 3000);
        return;
      }

      const nameModal = document.createElement('div');
      nameModal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
      nameModal.innerHTML = `
        <div class="rounded-xl shadow-2xl max-w-md w-full" style="background: var(--bg-primary);">
          <div class="px-6 py-4 gradient-header" style="border-radius: 0.75rem 0.75rem 0 0;">
            <h2 class="text-xl font-bold" style="color: white;">üì± Xu·∫•t h√¨nh th·ªùi kh√≥a bi·ªÉu</h2>
          </div>
          <div class="p-6">
            <div class="mb-6">
              <label class="block text-sm font-medium mb-2" style="color: var(--text-primary);">T√™n h·ªçc sinh (kh√¥ng b·∫Øt bu·ªôc):</label>
              <input 
                type="text" 
                id="student-name-input" 
                placeholder="Nh·∫≠p t√™n h·ªçc sinh..."
                class="w-full px-4 py-2.5 rounded-lg text-sm"
                style="background: var(--bg-secondary); border: 1px solid var(--border-color); color: var(--text-primary);"
              />
            </div>
            <button onclick="exportWithName()" class="w-full px-6 py-4 rounded-lg font-medium transition-all hover:scale-105 mb-3" style="background: var(--accent-color); color: white;">
              üì± Xu·∫•t h√¨nh<br/><span style="font-size: 0.75rem; opacity: 0.9;">1080x1920</span>
            </button>
            <button onclick="this.closest('.fixed').remove()" class="w-full px-4 py-2 rounded-lg text-sm font-medium" style="color: var(--text-secondary);">
              H·ªßy
            </button>
          </div>
        </div>
      `;
      document.body.appendChild(nameModal);

      window.exportWithName = async () => {
        const studentName = document.getElementById('student-name-input').value.trim();
        nameModal.remove();
        
        const toast = document.createElement('div');
        toast.className = 'fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg z-50';
        toast.style.background = '#3b82f6';
        toast.style.color = 'white';
        toast.textContent = 'üì± ƒêang t·∫°o h√¨nh ·∫£nh...';
        document.body.appendChild(toast);

        try {
          const width = 1080;
          const height = 1920;

          const exportContainer = document.createElement('div');
          exportContainer.style.position = 'absolute';
          exportContainer.style.left = '-9999px';
          exportContainer.style.width = width + 'px';
          exportContainer.style.height = height + 'px';
          exportContainer.style.background = getComputedStyle(document.body).getPropertyValue('--bg-secondary');
          exportContainer.style.padding = '30px';
          exportContainer.style.fontFamily = "'Noto Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif";
          exportContainer.style.boxSizing = 'border-box';
          exportContainer.style.overflow = 'hidden';
          document.body.appendChild(exportContainer);

          let schedule;
          if (currentView === 'class') {
            schedule = scheduleByClass[currentSelection];
          } else if (currentView === 'teacher') {
            schedule = scheduleByTeacher[currentSelection];
          } else if (currentView === 'room') {
            schedule = scheduleByRoom[currentSelection];
          }

          const morningTimes = ['7:00-7:45', '7:45-8:30', '9:00-9:45', '9:45-10:30', '10:30-11:15'];
          const afternoonTimes = ['1:00-1:45', '1:45-2:30', '2:30-3:15', '3:45-4:30', '4:30-5:15'];

          const hasLesson = (period) => days.some(day => schedule[day] && schedule[day][period]);
          const activeMorningPeriods = morningPeriods.filter(hasLesson);
          const activeAfternoonPeriods = afternoonPeriods.filter(hasLesson);

          const gradientStart = getComputedStyle(document.body).getPropertyValue('--accent-color');
          const gradientEnd = getComputedStyle(document.body).getPropertyValue('--text-secondary');

          let html = `
            <div style="background: ${getComputedStyle(document.body).getPropertyValue('--bg-primary')}; border-radius: 20px; overflow: hidden; box-shadow: 0 20px 60px rgba(0,0,0,0.15); height: 100%; display: flex; flex-direction: column;">
              <!-- Header -->
              <div style="padding: 28px; background: linear-gradient(135deg, ${gradientStart} 0%, ${gradientEnd} 100%); color: white;">
                <h1 style="font-size: 36px; font-weight: 700; margin: 0 0 8px 0; text-shadow: 0 2px 4px rgba(0,0,0,0.1);">üìö ${config.app_title}</h1>
                <p style="font-size: 16px; margin: 0; opacity: 0.95;">${config.school_name}</p>
                <div style="margin-top: 18px; padding-top: 18px; border-top: 2px solid rgba(255,255,255,0.3);">
                  <p style="font-size: 28px; margin: 0; font-weight: 600;">
                    ${currentView === 'class' ? `üè´ L·ªõp ${currentSelection}` : (currentView === 'teacher' ? `üë®‚Äçüè´ ${currentSelection}` : `üö™ Ph√≤ng ${currentSelection}`)}
                  </p>
                  ${studentName ? `<p style="font-size: 22px; margin: 10px 0 0 0; font-weight: 600;">üë§ ${studentName}</p>` : ''}
                </div>
              </div>

              <!-- Schedule Table -->
              <div style="padding: 24px; flex: 1; overflow: hidden;">
                <table style="width: 100%; border-collapse: separate; border-spacing: 0; font-size: 15px;">
                  <thead>
                    <tr>
                      <th style="padding: 14px; text-align: left; font-weight: 600; text-transform: uppercase; color: ${getComputedStyle(document.body).getPropertyValue('--text-secondary')}; background: ${getComputedStyle(document.body).getPropertyValue('--bg-secondary')}; border: 2px solid ${getComputedStyle(document.body).getPropertyValue('--border-color')}; border-right: none;">
                        Ti·∫øt
                      </th>
          `;

          days.forEach((day, idx) => {
            html += `
              <th style="padding: 14px; text-align: center; font-weight: 600; text-transform: uppercase; color: ${getComputedStyle(document.body).getPropertyValue('--text-secondary')}; background: ${getComputedStyle(document.body).getPropertyValue('--bg-secondary')}; border: 2px solid ${getComputedStyle(document.body).getPropertyValue('--border-color')}; ${idx < days.length - 1 ? 'border-right: none;' : ''}">
                ${day}
              </th>
            `;
          });

          html += `</tr></thead><tbody>`;

          // Morning sessions
          activeMorningPeriods.forEach((period) => {
            const periodIdx = morningPeriods.indexOf(period);
            html += `<tr>
              <td style="padding: 14px; font-weight: 500; background: ${getComputedStyle(document.body).getPropertyValue('--bg-secondary')}; border: 2px solid ${getComputedStyle(document.body).getPropertyValue('--border-color')}; border-top: none; border-right: none; color: ${getComputedStyle(document.body).getPropertyValue('--text-primary')};">
                <div style="font-weight: 600; font-size: 15px;">S√°ng ${periodIdx + 1}</div>
                <div style="opacity: 0.6; font-size: 13px; margin-top: 2px;">${morningTimes[periodIdx]}</div>
              </td>
            `;

            days.forEach((day, idx) => {
              const lesson = schedule[day] ? schedule[day][period] : null;
              if (lesson) {
                html += `
                  <td style="padding: 10px; border: 2px solid ${getComputedStyle(document.body).getPropertyValue('--border-color')}; border-top: none; ${idx < days.length - 1 ? 'border-right: none;' : ''}">
                    <div style="background: ${getComputedStyle(document.body).getPropertyValue('--morning-bg')}; border-radius: 12px; padding: 16px; box-shadow: 0 2px 6px rgba(0,0,0,0.08); min-height: 100px; display: flex; flex-direction: column; justify-content: center;">
                      <div style="font-size: 22px; font-weight: 700; margin-bottom: 10px; color: ${getComputedStyle(document.body).getPropertyValue('--text-primary')}; line-height: 1.2;">${lesson.subject}</div>
                      ${currentView === 'class' ? `<div style="font-size: 17px; opacity: 0.85; color: ${getComputedStyle(document.body).getPropertyValue('--text-primary')}; font-weight: 500; margin-bottom: 5px;">${lesson.teacher}</div>` : ''}
                      ${currentView === 'class' && lesson.room ? `<div style="font-size: 15px; opacity: 0.7; color: ${getComputedStyle(document.body).getPropertyValue('--text-primary')};">${lesson.room}</div>` : ''}
                      ${currentView === 'teacher' ? `<div style="font-size: 17px; opacity: 0.85; color: ${getComputedStyle(document.body).getPropertyValue('--text-primary')}; font-weight: 500; margin-bottom: 5px;">${lesson.class}</div>` : ''}
                      ${currentView === 'teacher' && lesson.room ? `<div style="font-size: 15px; opacity: 0.7; color: ${getComputedStyle(document.body).getPropertyValue('--text-primary')};">${lesson.room}</div>` : ''}
                      ${currentView === 'room' ? `<div style="font-size: 17px; opacity: 0.85; color: ${getComputedStyle(document.body).getPropertyValue('--text-primary')}; font-weight: 500; margin-bottom: 5px;">${lesson.class}</div>` : ''}
                      ${currentView === 'room' && lesson.teacher ? `<div style="font-size: 15px; opacity: 0.7; color: ${getComputedStyle(document.body).getPropertyValue('--text-primary')};">${lesson.teacher}</div>` : ''}
                    </div>
                  </td>
                `;
              } else {
                html += `<td style="border: 2px solid ${getComputedStyle(document.body).getPropertyValue('--border-color')}; border-top: none; ${idx < days.length - 1 ? 'border-right: none;' : ''}"></td>`;
              }
            });

            html += `</tr>`;
          });

          // Afternoon sessions
          activeAfternoonPeriods.forEach((period) => {
            const periodIdx = afternoonPeriods.indexOf(period);
            html += `<tr>
              <td style="padding: 14px; font-weight: 500; background: ${getComputedStyle(document.body).getPropertyValue('--bg-secondary')}; border: 2px solid ${getComputedStyle(document.body).getPropertyValue('--border-color')}; border-top: none; border-right: none; color: ${getComputedStyle(document.body).getPropertyValue('--text-primary')};">
                <div style="font-weight: 600; font-size: 15px;">Chi·ªÅu ${periodIdx + 1}</div>
                <div style="opacity: 0.6; font-size: 13px; margin-top: 2px;">${afternoonTimes[periodIdx]}</div>
              </td>
            `;

            days.forEach((day, idx) => {
              const lesson = schedule[day] ? schedule[day][period] : null;
              if (lesson) {
                html += `
                  <td style="padding: 10px; border: 2px solid ${getComputedStyle(document.body).getPropertyValue('--border-color')}; border-top: none; ${idx < days.length - 1 ? 'border-right: none;' : ''}">
                    <div style="background: ${getComputedStyle(document.body).getPropertyValue('--afternoon-bg')}; border-radius: 12px; padding: 16px; box-shadow: 0 2px 6px rgba(0,0,0,0.08); min-height: 100px; display: flex; flex-direction: column; justify-content: center;">
                      <div style="font-size: 22px; font-weight: 700; margin-bottom: 10px; color: ${getComputedStyle(document.body).getPropertyValue('--text-primary')}; line-height: 1.2;">${lesson.subject}</div>
                      ${currentView === 'class' ? `<div style="font-size: 17px; opacity: 0.85; color: ${getComputedStyle(document.body).getPropertyValue('--text-primary')}; font-weight: 500; margin-bottom: 5px;">${lesson.teacher}</div>` : ''}
                      ${currentView === 'class' && lesson.room ? `<div style="font-size: 15px; opacity: 0.7; color: ${getComputedStyle(document.body).getPropertyValue('--text-primary')};">${lesson.room}</div>` : ''}
                      ${currentView === 'teacher' ? `<div style="font-size: 17px; opacity: 0.85; color: ${getComputedStyle(document.body).getPropertyValue('--text-primary')}; font-weight: 500; margin-bottom: 5px;">${lesson.class}</div>` : ''}
                      ${currentView === 'teacher' && lesson.room ? `<div style="font-size: 15px; opacity: 0.7; color: ${getComputedStyle(document.body).getPropertyValue('--text-primary')};">${lesson.room}</div>` : ''}
                      ${currentView === 'room' ? `<div style="font-size: 17px; opacity: 0.85; color: ${getComputedStyle(document.body).getPropertyValue('--text-primary')}; font-weight: 500; margin-bottom: 5px;">${lesson.class}</div>` : ''}
                      ${currentView === 'room' && lesson.teacher ? `<div style="font-size: 15px; opacity: 0.7; color: ${getComputedStyle(document.body).getPropertyValue('--text-primary')};">${lesson.teacher}</div>` : ''}
                    </div>
                  </td>
                `;
              } else {
                html += `<td style="border: 2px solid ${getComputedStyle(document.body).getPropertyValue('--border-color')}; border-top: none; ${idx < days.length - 1 ? 'border-right: none;' : ''}"></td>`;
              }
            });

            html += `</tr>`;
          });

          html += `</tbody></table>
              </div>

              <!-- Footer -->
              <div style="padding: 18px 24px; background: ${getComputedStyle(document.body).getPropertyValue('--bg-secondary')}; border-top: 2px solid ${getComputedStyle(document.body).getPropertyValue('--border-color')}; text-align: center;">
                <p style="margin: 0; font-size: 13px; color: ${getComputedStyle(document.body).getPropertyValue('--text-secondary')};">
                  Xu·∫•t l√∫c ${new Date().toLocaleString('vi-VN')}
                </p>
              </div>
            </div>
          `;

          exportContainer.innerHTML = html;

          const canvas = await html2canvas(exportContainer, {
            scale: 2,
            backgroundColor: getComputedStyle(document.body).getPropertyValue('--bg-secondary'),
            logging: false,
            width: width,
            height: height
          });

          document.body.removeChild(exportContainer);

          canvas.toBlob((blob) => {
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            const filename = `TKB_${currentSelection.replace(/\s+/g, '_')}_${new Date().getTime()}.png`;
            link.download = filename;
            link.href = url;
            link.click();
            URL.revokeObjectURL(url);

            toast.style.background = '#16a34a';
            toast.textContent = '‚úÖ ƒê√£ t·∫£i h√¨nh ·∫£nh!';
            setTimeout(() => toast.remove(), 3000);
          });

        } catch (error) {
          console.error('Export error:', error);
          toast.style.background = '#dc2626';
          toast.textContent = '‚ùå L·ªói khi xu·∫•t h√¨nh!';
          setTimeout(() => toast.remove(), 3000);
        }
      };
    }

    // Auto-load from Google Sheet on page load
    loadFromGoogleSheet();
  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9befee4a11bcdd39',t:'MTc2ODU5MDgxNC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>

